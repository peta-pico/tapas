<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tapas</title>
<link href='http://cdn.jsdelivr.net/g/yasr@2.4(yasr.min.css)' rel='stylesheet' type='text/css'/>
<!--<link href='lib/yasr.css' rel='stylesheet' type='text/css'/>-->

<style>
body {
  background-color: #fff;
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size: 14px;
  line-height: 1.42857;
  color: #333;
}
a{
  color:#428bca;
  text-decoration:none
}
a:hover,a:active{
  outline:0;
  color:#2a6496;
  text-decoration:underline
}
#form {
  border-bottom-width: 3px;
  border-color: #333;
  border-bottom-style: solid;
}
button {
  color:#333;
  border:1px solid transparent;
  background-color:#fff;
  border-color:#ccc;
  border-width:1px;
  display:inline-block;
  text-align:center;
  vertical-align:middle;
  cursor:pointer;
  white-space:nowrap;
  padding:6px 12px;
  border-radius:4px;
  overflow:visible;
  box-sizing:border-box;
}
button:hover {
  outline:0;
  background-color:#ebebeb;
  border-color:#adadad;
}
button:active {
  color:#fff;
  outline:0;
  background-color:#337ab7;
  border-color:#337ab7
}
input {
  margin-left:.5em;
}
.string_input, .iri_input {
  width: 50em;
}
#page-input {
  width: 3em;
}
</style>
</head>

<body>

<h2 id="title">Tapas</h2>

<p id="loading" style="display:none">Loading...</p>

<div id="oplist" style="display:none"></div>

<div id="content" style="display:none">

<p id="summary"></p>

<div id="form">

<table id="input-fields"></table>

<p><button id="submit">submit</button></p>

</div>

<div id="yasr"></div>

</div>

<script src='tapas-config.js'></script>
<script src='local-tapas-config.js'></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/json2html/1.2.0/json2html.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.json2html/1.2.0/jquery.json2html.min.js"></script>
<script src='http://cdn.jsdelivr.net/yasr/2.4/yasr.bundled.min.js'></script>
<!--
<script src="lib/jquery.min.js"></script>
<script src='lib/yasr.bundled.min.js'></script>
-->


<script>

$.urlParam = function(name) {
  var p = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
  if (p == null) {
    return null;
  } else {
    return decodeURI(p[1]) || 0;
  }
}

var api = $.urlParam('api');
var op = $.urlParam('op');

var yasr = YASR($("#yasr"));

var params = [];
var requiredParams = [];

var transforms = {
  form:{'<>':'tr', html:function() {
    if (this.name != "page" && this.name != "endpoint") {
      params.push(this.name);
      if (this.type === "iri") {
        return( json2html.transform(this, transforms.iri_input) );
      } else {
        return( json2html.transform(this, transforms.string_input) );
      }
    } else {
      return '';
    }
  }},
  string_input:[
    {'<>':'td', 'text':'${name}: '},
    {'<>':'td', 'html':[
      {'<>':'input', 'class':'string_input', 'id':'input_${name}'},
      {'<>':'span', 'text':function() {
        if (this.required) {
          requiredParams.push(this.name);
          return ' (required)';
        }
      }}
    ]}
  ],
  iri_input:[
    {'<>':'td', 'text':'${name}: '},
    {'<>':'td', 'html':[
      {'<>':'input', 'class':'iri_input', 'placeholder':'http://...', 'id':'input_${name}'},
      {'<>':'span', 'text':function() {
        if (this.required) {
          requiredParams.push(this.name);
          return ' (required)';
        }
      }}
    ]}
  ],
  ops:{'<>':'ul', 'html':[
    {'<>':'li', 'html':[
      {'<>':'a', 'href':('?api=' + api + '&op=${key}'), 'text':'${key}'}
    ]}
  ]}
};

function showResults() {
  yasr.setResponse({response:'getting results...'});
  var url = grlcInstance + "/api/" + api + op + '?&'
  for (var i = 0; i < params.length; i++) {
    var n = params[i];
    url = url + '&' + n + '=' + encodeURIComponent(document.getElementById('input_' + n).value);
  }
  $.ajax({
    type: "GET",
    url: url,
    success: function(data,status,xhr) {
      yasr.setResponse({
        response:data,
        contentType: 'text/csv'
      });
    }
  })
}

if (op) {
  $('#title').html('<a href="?api=' + api + '">' + api.replace(/.*\//g,'') + '</a>: ' + op.replace(/^\//, ''));

  $('#loading').show();
  $.getJSON(grlcInstance + "/api/" + api + "/spec", function(data) {
    $('#input-fields').json2html(data.paths[op].get.parameters, transforms.form);
    if (data.paths[op].get.summary) {
      $('#summary').html(data.paths[op].get.summary);
    }
    $('#loading').hide();
    $('#oplist').hide();
    $('#content').show();
  });

  document.getElementById('submit').onclick=showResults

} else if (api) {
  $('#title').html(api);

  $('#loading').show();
  $.getJSON(grlcInstance + "/api/" + api + "/spec", function(data) {
    $('#oplist').json2html(Object.keys(data.paths).map(key => ({ key:key })), transforms.ops);
    $('#loading').hide();
    $('#oplist').show();
  });
} else {
  $('#title').html('Tapas: add ?api=... to URL');
}

</script>
</body>

